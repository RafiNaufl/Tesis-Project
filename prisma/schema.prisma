generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String         @id @default(cuid())
  name            String
  email           String         @unique
  hashedPassword  String
  profileImageUrl String?
  role            String         @default("EMPLOYEE")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  employee        Employee?
  notifications   Notification[]
  deviceTokens    DeviceToken[]
  sessions        Session[]

  @@map("users")
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("android") // "android", "ios", "web"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Employee {
  id                  String            @id @default(cuid())
  employeeId          String            @unique
  userId              String            @unique
  position            String
  division            String
  basicSalary         Float
  joiningDate         DateTime
  contactNumber       String?           @unique
  address             String?
  isActive            Boolean           @default(true)
  organization        String?
  employmentStatus    String?
  workScheduleType    String?
  hourlyRate          Float?
  bpjsKesehatan       Float             @default(0)
  bpjsKetenagakerjaan Float             @default(0)
  advances            Advance[]
  allowances          Allowance[]
  attendances         Attendance[]
  auditLogs           AuditLog[]
  deductions          Deduction[]
  employeeIdLogs      EmployeeIdLog[]
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveRequests       Leave[]
  overtimeRequests    OvertimeRequest[]
  payrolls            Payroll[]
  softLoans           SoftLoan[]

  @@map("employees")
}

model Organization {
  id              String   @id @default(cuid())
  name            String
  code            String   @unique
  currentSequence Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("organizations")
}

model EmployeeIdLog {
  id            String   @id @default(cuid())
  employeeId    String
  oldEmployeeId String?
  newEmployeeId String
  changedBy     String?
  reason        String?
  createdAt     DateTime @default(now())
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("employee_id_logs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  refType   String?
  refId     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Attendance {
  id                       String               @id @default(cuid())
  employeeId               String
  date                     DateTime             @default(now())
  updatedAt                DateTime             @default(now()) @updatedAt
  checkIn                  DateTime?
  checkOut                 DateTime?
  overtimeStart            DateTime?
  overtimeEnd              DateTime?
  status                   String               @default("ABSENT")
  notes                    String?
  isLate                   Boolean              @default(false)
  lateMinutes              Int                  @default(0)
  overtime                 Int                  @default(0)
  isOvertimeApproved       Boolean              @default(false)
  isSundayWork             Boolean              @default(false)
  isSundayWorkApproved     Boolean              @default(false)
  approvedBy               String?
  approvedAt               DateTime?
  checkInLatitude          Float?
  checkInLongitude         Float?
  checkInPhotoUrl          String?
  checkOutLatitude         Float?
  checkOutLongitude        Float?
  checkOutPhotoUrl         String?
  overtimeStartLatitude    Float?
  overtimeStartLongitude   Float?
  overtimeStartPhotoUrl    String?
  overtimeStartAddressNote String?
  overtimeEndLatitude      Float?
  overtimeEndLongitude     Float?
  overtimeEndPhotoUrl      String?
  overtimeEndAddressNote   String?
  lateReason               String?
  latePhotoUrl             String?
  lateSubmittedAt          DateTime?
  lateApprovalStatus       String?
  approvalLogs             ApprovalLog[]
  attendanceAuditLogs      AttendanceAuditLog[]
  employee                 Employee             @relation(fields: [employeeId], references: [id])
  auditLogs                AuditLog[]

  @@unique([employeeId, date])
  @@map("attendances")
}

model ApprovalLog {
  id           String     @id @default(cuid())
  attendanceId String
  action       String
  actorUserId  String
  note         String?
  createdAt    DateTime   @default(now())
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@map("approval_logs")
}

model AuditLog {
  id           String      @id @default(cuid())
  actorUserId  String
  action       String
  attendanceId String?
  employeeId   String?
  ip           String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime    @default(now())
  attendance   Attendance? @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  employee     Employee?   @relation(fields: [employeeId], references: [id])

  @@map("audit_logs")
}

model Payroll {
  id                        String            @id @default(cuid())
  employeeId                String
  month                     Int
  year                      Int
  baseSalary                Float
  totalAllowances           Float             @default(0)
  totalDeductions           Float             @default(0)
  netSalary                 Float
  daysPresent               Float
  daysAbsent                Float
  daysLate                  Int               @default(0)
  overtimeHours             Float             @default(0)
  overtimeAmount            Float             @default(0)
  lateDeduction             Float             @default(0)
  advanceDeduction          Float             @default(0)
  softLoanDeduction         Float             @default(0)
  bpjsKesehatanAmount       Float             @default(0)
  bpjsKetenagakerjaanAmount Float             @default(0)
  status                    String            @default("PENDING")
  createdAt                 DateTime          @default(now())
  paidAt                    DateTime?
  deductions                Deduction[]
  auditLogs                 PayrollAuditLog[]
  employee                  Employee          @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@map("payrolls")
}

model CompanyWorkHours {
  id            String   @id @default(cuid())
  weekdayStart  String   @default("08:00")
  weekdayEnd    String   @default("16:30")
  saturdayStart String   @default("08:00")
  saturdayEnd   String   @default("12:00")
  lateThreshold String   @default("08:30")
  effectiveDate DateTime @default(now())

  @@map("company_work_hours")
}

model PenaltyConfig {
  id                    String   @id @default(cuid())
  latePerDayAmount      Float    @default(30000)
  maxLateDailyPercent   Float    @default(100)
  absencePenaltyPercent Float    @default(100)
  effectiveDate         DateTime @default(now())

  @@map("penalty_config")
}

model OvertimeConfig {
  id                    String   @id @default(cuid())
  rateMultiplier        Float    @default(1.5)
  sundayMultiplier      Float    @default(2.0)
  holidayMultiplier     Float    @default(2.0)
  maxDailyOvertimeHours Float    @default(12)
  effectiveDate         DateTime @default(now())

  @@map("overtime_config")
}

model PublicHoliday {
  id          String   @id @default(cuid())
  date        DateTime @unique
  description String

  @@map("public_holidays")
}

model OvertimeRequest {
  id         String    @id @default(cuid())
  employeeId String
  date       DateTime
  start      DateTime
  end        DateTime
  reason     String?
  status     String    @default("PENDING")
  approvedBy String?
  approvedAt DateTime?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  employee   Employee  @relation(fields: [employeeId], references: [id])

  @@map("overtime_requests")
}

model PayrollAuditLog {
  id        String   @id @default(cuid())
  payrollId String?
  userId    String
  action    String
  oldValue  Json?
  newValue  Json?
  timestamp DateTime @default(now())
  payroll   Payroll? @relation(fields: [payrollId], references: [id])

  @@map("payroll_audit_logs")
}

model AttendanceAuditLog {
  id           String      @id @default(cuid())
  attendanceId String?
  userId       String
  action       String
  oldValue     Json?
  newValue     Json?
  timestamp    DateTime    @default(now())
  attendance   Attendance? @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@map("attendance_audit_logs")
}

model PayrollConfig {
  id             String   @id @default(cuid())
  minMonthlyWage Float    @default(3500000)
  minHourlyWage  Float    @default(20000)
  effectiveDate  DateTime @default(now())

  @@map("payroll_config")
}

model Deduction {
  id         String   @id @default(cuid())
  employeeId String
  month      Int
  year       Int
  reason     String
  amount     Float
  date       DateTime @default(now())
  type       String   @default("OTHER")
  payrollId  String?
  employee   Employee @relation(fields: [employeeId], references: [id])
  payroll    Payroll? @relation(fields: [payrollId], references: [id])

  @@map("deductions")
}

model Allowance {
  id         String   @id @default(cuid())
  employeeId String
  month      Int
  year       Int
  type       String
  amount     Float
  date       DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id])

  @@map("allowances")
}

model Leave {
  id         String    @id @default(cuid())
  employeeId String
  startDate  DateTime
  endDate    DateTime
  reason     String
  type       String
  status     String    @default("PENDING")
  approvedBy String?
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  employee   Employee  @relation(fields: [employeeId], references: [id])

  @@map("leaves")
}

model Advance {
  id              String    @id @default(cuid())
  employeeId      String
  amount          Float
  month           Int
  year            Int
  reason          String?
  status          String    @default("PENDING")
  rejectionReason String?
  deductionMonth  Int?
  deductionYear   Int?
  createdAt       DateTime  @default(now())
  deductedAt      DateTime?
  employee        Employee  @relation(fields: [employeeId], references: [id])

  @@map("advances")
}

model SoftLoan {
  id              String    @id @default(cuid())
  employeeId      String
  totalAmount     Float
  monthlyAmount   Float
  remainingAmount Float
  durationMonths  Int
  startMonth      Int
  startYear       Int
  reason          String?
  status          String    @default("PENDING")
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  employee        Employee  @relation(fields: [employeeId], references: [id])

  @@map("soft_loans")
}
